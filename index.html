<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Creador de Series Manga (v3 - Ordenable)</title>
    <style>
        /* --- ESTILOS GLOBALES Y DEL PANEL DE ADMIN --- */
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --primary-color: #1e1e1e;
            --accent-color: #BB86FC;
            --danger-color: #cf6679;
        }
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: Arial, sans-serif;
        }
        .app-container { padding: 20px; max-width: 1000px; margin: 0 auto; }
        h1, h2 { text-align: center; color: var(--accent-color); }
        button { cursor: pointer; padding: 10px 20px; border: none; border-radius: 5px; font-size: 16px; transition: 0.3s; }
        .btn-primary { background-color: var(--accent-color); color: black; font-weight: bold; }
        .btn-primary:hover { background-color: #9955dd; }
        .btn-danger { background-color: var(--danger-color); color: black; }
        .hidden { display: none !important; }

        /* Estilos del Dashboard */
        .chapter-list { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .chapter-item { background: var(--primary-color); padding: 15px; display: flex; justify-content: space-between; align-items: center; border-radius: 8px; }
        .chapter-actions { display: flex; gap: 10px; }

        /* Estilos del Editor */
        .editor-form { background: var(--primary-color); padding: 20px; border-radius: 8px; display: flex; flex-direction: column; gap: 15px; }
        input[type="text"], input[type="file"] { padding: 10px; background: #333; border: 1px solid #555; color: white; border-radius: 4px; width: 100%; box-sizing: border-box; }
        
        /* Contenedor de Previsualizaci√≥n (NUEVO: Contenedor para Drag and Drop) */
        #image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            border: 1px dashed #555;
            min-height: 100px;
        }

        /* √çtem de imagen para arrastrar (NUEVO: Estilos de Arrastre) */
        .preview-img-wrapper {
            position: relative;
            cursor: grab;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 2px solid transparent;
            transition: border-color 0.2s;
            background: #252525;
            padding: 5px;
            border-radius: 5px;
        }
        .preview-img-wrapper:hover { border-color: var(--accent-color); }
        .preview-img-wrapper.dragging { opacity: 0.5; }
        /* Indicador visual de d√≥nde caer√° el elemento */
        .preview-img-wrapper.drag-over-left { border-left: 4px solid #4CAF50; }
        .preview-img-wrapper.drag-over-right { border-right: 4px solid #4CAF50; }

        .preview-img-thumb {
            width: 100px;
            height: 140px;
            object-fit: cover;
            display: block;
        }
        .image-order-label {
            font-size: 0.8em;
            color: #ccc;
            margin-top: 5px;
        }
        
        /* Bot√≥n de eliminar en el editor */
        .remove-image-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            line-height: 1;
            padding: 0;
            cursor: pointer;
            z-index: 10;
        }

        /* --- ESTILOS DEL VISUALIZADOR (Tu dise√±o original) --- */
        #viewer-section {
            background-color: #121212;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .top-bar {
            background-color: #1f1f1f;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            border-bottom: 2px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .back-button {
            text-decoration: none;
            color: #e0e0e0;
            font-size: 24px;
            margin-right: 20px;
            padding: 5px 10px;
            border-radius: 50%;
            transition: background-color 0.3s ease;
        }
        .back-button:hover { background-color: #333; color: #ffffff; }
        .chapter-title { font-size: 20px; font-weight: bold; color: #ffffff; margin: 0; }
        
        /* Contenedor principal de im√°genes */
        .comic-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        .comic-page {
            width: 100%;
            height: auto;
            display: block;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            margin-bottom: 0;
        }
        
        /* Men√∫ Flotante */
        .floating-menu {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 200;
        }
        .menu-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background-color: #1f1f1f;
            color: #e0e0e0;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transition: all 0.3s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            text-decoration: none;
        }
        .menu-button:hover {
            background-color: #333;
            color: #ffffff;
            transform: scale(1.1);
        }
        .menu-button.active { background-color: #4CAF50; color: white; }
        .menu-button.disabled { opacity: 0.5; pointer-events: none; background-color: #151515; }

        /* Sub-p√°gina de descargas (Modal simulado) */
        .download-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 300;
            display: flex; justify-content: center; align-items: center;
        }
        .download-content {
            background: var(--primary-color); padding: 30px; border-radius: 10px; width: 80%; max-width: 500px; text-align: center;
            position: relative;
        }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; }
        .download-link-item {
            display: block; background: #333; padding: 15px; margin: 10px 0; border-radius: 5px; text-decoration: none; color: var(--accent-color); font-weight: bold;
        }
        .download-link-item:hover { background: #444; }

    </style>
</head>
<body>

    <div id="dashboard-section" class="app-container">
        <h1>Administrador de Series</h1>
        <div style="text-align: center; margin-bottom: 30px;">
            <button class="btn-primary" onclick="showEditor()">+ Crear Nuevo Cap√≠tulo</button>
            <p style="font-size: 0.8em; color: #999;">(Nota: Usa im√°genes ligeras, el almacenamiento del navegador es limitado)</p>
        </div>
        <div id="chapter-list-container" class="chapter-list">
            </div>
    </div>

    <div id="editor-section" class="app-container hidden">
        <h2>Editor de Cap√≠tulo</h2>
        <div class="editor-form">
            <div>
                <label>Nombre del Cap√≠tulo:</label>
                <input type="text" id="edit-title" placeholder="Ej: Cap√≠tulo 1: El Comienzo">
            </div>

            <div>
                <label>Subir Im√°genes del Manga:</label>
                <input type="file" id="edit-images" multiple accept="image/*">
                
                <p style="color: var(--accent-color); font-weight: bold; margin: 15px 0 5px;">
                    ‚û°Ô∏è **Arrastra y suelta las miniaturas de abajo para reordenar las p√°ginas.**
                </p>
                <div id="image-preview"></div>
            </div>

            <div>
                <label>Subir Archivo de Descarga (Ej: .zip, .pdf - Opcional):</label>
                 <input type="file" id="edit-download" accept=".zip,.rar,.pdf,.cbz">
                 <p style="font-size: 0.8em; color: #aaa;">Solo se permite 1 archivo de descarga por cap√≠tulo en esta versi√≥n.</p>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-primary" style="flex: 2;" onclick="saveChapter()">Guardar Cap√≠tulo</button>
                <button class="btn-danger" style="flex: 1;" onclick="showView('dashboard')">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="viewer-section" class="hidden">
         <div class="top-bar">
            <a href="#" onclick="showView('dashboard'); return false;" class="back-button">‚Üê</a>
            <h1 id="viewer-chapter-title" class="chapter-title">Cargando cap√≠tulo...</h1>
        </div>

        <main id="comic-pages-container" class="comic-container">
            </main>

        <nav class="floating-menu">
            <a href="#" id="btn-prev-cap" class="menu-button disabled" title="Cap√≠tulo Anterior">
                ‚èÆ
            </a>
             <button id="btn-download" class="menu-button" title="Descargas">
                ‚¨áÔ∏è
            </button>
            <button id="btn-autoscroll" class="menu-button" title="Activar Autoscroll">
                ‚ñ∂Ô∏è
            </button>
            <a href="#" id="btn-next-cap" class="menu-button disabled" title="Siguiente Cap√≠tulo">
                ‚è≠
            </a>
        </nav>

        <div id="download-modal" class="download-modal hidden">
            <div class="download-content">
                <span class="close-modal" onclick="toggleDownloadModal(false)">√ó</span>
                <h3>Descargas del Cap√≠tulo</h3>
                <div id="download-links-container">
                    <p>No hay descargas disponibles para este cap√≠tulo.</p>
                </div>
            </div>
        </div>
    </div>


    <script>
        // ====================================================================
        // L√ìGICA DE LA APLICACI√ìN (JAVASCRIPT)
        // ====================================================================

        // 1. ESTADO GLOBAL Y UTILIDADES
        let chapters = [];
        const STORAGE_KEY = 'mangaApp_chapters';
        let currentEditingId = null;
        let uploadedImageFiles = []; // Almacena temporalmente los DataURIs de las im√°genes para poder ordenarlas

        // Cargar datos al iniciar
        function loadData() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                chapters = JSON.parse(data);
            } else {
                chapters = [];
            }
            renderDashboard();
        }

        // Guardar datos
        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(chapters));
                renderDashboard();
            } catch (e) {
                alert("Error: El almacenamiento del navegador est√° lleno. Intenta usar im√°genes m√°s peque√±as o borra cap√≠tulos antiguos.");
                console.error(e);
            }
        }

        // Router simple (Cambiar entre Dashboard, Editor y Visualizador)
        function showView(viewName, chapterId = null) {
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('editor-section').classList.add('hidden');
            document.getElementById('viewer-section').classList.add('hidden');
            stopAutoscroll(); // Detener autoscroll si cambiamos de vista

            if (viewName === 'dashboard') {
                document.getElementById('dashboard-section').classList.remove('hidden');
                renderDashboard();
            } else if (viewName === 'editor') {
                document.getElementById('editor-section').classList.remove('hidden');
            } else if (viewName === 'viewer') {
                document.getElementById('viewer-section').classList.remove('hidden');
                loadChapterIntoViewer(chapterId);
            }
        }

        // ================= 2. L√ìGICA DEL DASHBOARD =================
        function renderDashboard() {
            const container = document.getElementById('chapter-list-container');
            container.innerHTML = '';
            if (chapters.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#777;">No hay cap√≠tulos creados. ¬°Usa el bot√≥n para empezar!</p>';
                return;
            }

            chapters.forEach((chapter, index) => {
                const item = document.createElement('div');
                item.className = 'chapter-item';
                item.innerHTML = `
                    <div>
                        <strong>#${index + 1}</strong> - ${chapter.title} 
                        <span style="font-size:0.8em">(${chapter.images.length} im√°genes)</span>
                    </div>
                    <div class="chapter-actions">
                        <button class="btn-primary" onclick="showView('viewer', '${chapter.id}')" style="background:#4CAF50;">Ver / Probar</button>
                        <button onclick="deleteChapter('${chapter.id}')" class="btn-danger">Eliminar</button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function deleteChapter(id) {
            if(confirm('¬øSeguro que quieres eliminar este cap√≠tulo?')) {
                chapters = chapters.filter(c => c.id !== id);
                saveData();
            }
        }

        // ================= 3. L√ìGICA DEL EDITOR (Subida, Arrastre y Guardado) =================
        function showEditor() {
            currentEditingId = Date.now().toString();
            document.getElementById('edit-title').value = '';
            document.getElementById('edit-images').value = '';
            document.getElementById('edit-download').value = '';
            uploadedImageFiles = []; // Limpiar archivos temporales
            renderImagePreviews();
            showView('editor');
        }

        // Event listener para cuando se seleccionan archivos
        document.getElementById('edit-images').addEventListener('change', async function(e) {
             const newFiles = Array.from(this.files);
             // Leer cada archivo y convertirlo a Data URL (Base64)
             const newImageDataUrls = await Promise.all(newFiles.map(file => {
                 return new Promise(resolve => {
                     const reader = new FileReader();
                     reader.onload = (e) => resolve(e.target.result);
                     reader.readAsDataURL(file);
                 });
             }));
             // A√±adir los nuevos Data URIs al array de trabajo
             uploadedImageFiles = uploadedImageFiles.concat(newImageDataUrls);
             renderImagePreviews();
             this.value = ''; // Resetear el input file para que se puedan subir m√°s
        });


        // Generar las miniaturas de im√°genes en el editor
        function renderImagePreviews() {
            const previewArea = document.getElementById('image-preview');
            previewArea.innerHTML = '';
            
            if (uploadedImageFiles.length === 0) {
                previewArea.innerHTML = '<p style="color:#777; text-align:center; padding:20px;">Sube im√°genes para empezar a ordenar.</p>';
                return;
            }

            uploadedImageFiles.forEach((imgDataUrl, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'preview-img-wrapper';
                wrapper.draggable = true; // Habilitar arrastre
                wrapper.dataset.index = index; // Guardar √≠ndice para JS de arrastre

                const img = document.createElement('img');
                img.src = imgDataUrl;
                img.className = 'preview-img-thumb';

                const label = document.createElement('span');
                label.className = 'image-order-label';
                label.textContent = `#${index + 1}`;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-image-btn';
                removeBtn.textContent = '√ó';
                removeBtn.onclick = () => removeImage(index);

                wrapper.appendChild(removeBtn);
                wrapper.appendChild(img);
                wrapper.appendChild(label);
                previewArea.appendChild(wrapper);
            });
            addDragListeners(); // Aplicar listeners de arrastrar y soltar a los nuevos elementos
        }

        function removeImage(indexToRemove) {
            uploadedImageFiles.splice(indexToRemove, 1);
            renderImagePreviews(); // Re-renderizar para actualizar el orden y la interfaz
        }

        // L√ìGICA DE DRAG AND DROP
        let dragSrcEl = null;

        function handleDragStart(e) {
            this.classList.add('dragging');
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            this.classList.remove('drag-over-left', 'drag-over-right');
            // Indica visualmente d√≥nde caer√° el elemento (izquierda o derecha del target)
            const rect = this.getBoundingClientRect();
            const x = e.clientX - rect.left;
            if (x < rect.width / 2) {
                this.classList.add('drag-over-left');
            } else {
                this.classList.add('drag-over-right');
            }
        }

        function handleDragLeave() {
            this.classList.remove('drag-over-left', 'drag-over-right');
        }

        function handleDrop(e) {
            e.stopPropagation();
            
            if (dragSrcEl !== this) {
                const dragIndex = parseInt(dragSrcEl.dataset.index);
                const dropIndex = parseInt(this.dataset.index);

                // Reordenar el array de archivos
                const draggedItem = uploadedImageFiles[dragIndex];
                uploadedImageFiles.splice(dragIndex, 1);
                
                // Determinar la nueva posici√≥n de inserci√≥n
                const rect = this.getBoundingClientRect();
                const x = e.clientX - rect.left;
                let newIndex = dropIndex;
                if (x > rect.width / 2) {
                    newIndex = dropIndex + 1; // Insertar despu√©s del elemento
                }
                
                // Si movemos un elemento hacia la izquierda, a veces el dropIndex necesita ajustarse
                // Para simplificar, simplemente re-renderizaremos que es m√°s limpio.

                uploadedImageFiles.splice(newIndex > uploadedImageFiles.length ? uploadedImageFiles.length : newIndex, 0, draggedItem);
                renderImagePreviews(); // Volver a dibujar para reflejar el nuevo orden
            }
            this.classList.remove('drag-over-left', 'drag-over-right');
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
            const items = document.querySelectorAll('.preview-img-wrapper');
            items.forEach(item => {
                item.classList.remove('drag-over-left', 'drag-over-right');
            });
        }

        function addDragListeners() {
            const items = document.querySelectorAll('.preview-img-wrapper');
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        async function saveChapter() {
            const title = document.getElementById('edit-title').value;
            const downloadFile = document.getElementById('edit-download').files[0];
            // Importante: uploadedImageFiles ya tiene el orden correcto por el drag and drop

            if (!title || uploadedImageFiles.length === 0) {
                alert("Por favor a√±ade un t√≠tulo y al menos una imagen.");
                return;
            }

            const saveBtn = document.querySelector('#editor-section .btn-primary');
            saveBtn.textContent = 'Procesando y Guardando... (Espera)';
            saveBtn.disabled = true;

            try {
                // Las im√°genes ya est√°n en uploadedImageFiles en el orden correcto y en DataURI
                const imageDataArray = uploadedImageFiles; 

                // Procesar archivo de descarga (si existe)
                let downloadData = null;
                if (downloadFile) {
                     downloadData = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve({ name: downloadFile.name, data: e.target.result });
                        reader.onerror = reject;
                        reader.readAsDataURL(downloadFile);
                    });
                }

                const newChapter = {
                    id: currentEditingId,
                    title: title,
                    images: imageDataArray,
                    download: downloadData
                };

                // A√±adir el nuevo cap√≠tulo y guardar
                chapters.push(newChapter);
                saveData();
                showView('dashboard');

            } catch (error) {
                alert("Error al procesar los archivos. " + error);
            } finally {
                saveBtn.textContent = 'Guardar Cap√≠tulo';
                saveBtn.disabled = false;
            }
        }

        // ================= 4. L√ìGICA DEL VISUALIZADOR (Sin cambios) =================
        let isScrolling = false;
        let scrollSpeed = 1;
        let scrollInterval;
        const btnAutoscroll = document.getElementById('btn-autoscroll');
        const btnDownload = document.getElementById('btn-download');
        const modalDownload = document.getElementById('download-modal');
        let currentDownloadData = null;

        function loadChapterIntoViewer(id) {
            const chapterIndex = chapters.findIndex(c => c.id === id);
            const chapterData = chapters[chapterIndex];
            if (!chapterData) return;

            // 1. Poner T√≠tulo y Resetear Scroll
            document.getElementById('viewer-chapter-title').textContent = chapterData.title;
            window.scrollTo(0, 0);

            // 2. Inyectar Im√°genes
            const container = document.getElementById('comic-pages-container');
            container.innerHTML = '';
            chapterData.images.forEach(imgData => {
                const img = document.createElement('img');
                img.src = imgData;
                img.className = 'comic-page';
                container.appendChild(img);
            });

            // 3. Configurar Navegaci√≥n Inteligente (Lista Enlazada)
            const prevBtn = document.getElementById('btn-prev-cap');
            const nextBtn = document.getElementById('btn-next-cap');
            
            // L√≥gica para bot√≥n ANTERIOR
            if (chapterIndex > 0) {
                const prevChapterId = chapters[chapterIndex - 1].id;
                prevBtn.classList.remove('disabled');
                prevBtn.onclick = (e) => { e.preventDefault(); showView('viewer', prevChapterId); };
            } else {
                prevBtn.classList.add('disabled');
                prevBtn.onclick = (e) => e.preventDefault();
            }

            // L√≥gica para bot√≥n SIGUIENTE
            if (chapterIndex < chapters.length - 1) {
                const nextChapterId = chapters[chapterIndex + 1].id;
                nextBtn.classList.remove('disabled');
                nextBtn.onclick = (e) => { e.preventDefault(); showView('viewer', nextChapterId); };
            } else {
                nextBtn.classList.add('disabled');
                nextBtn.onclick = (e) => e.preventDefault();
            }

            // 4. Configurar Datos de Descarga
            currentDownloadData = chapterData.download;
        }


        // --- FUNCIONALIDADES DEL MEN√ö ---

        // Autoscroll
        function toggleAutoscroll() {
            if (isScrolling) {
                stopAutoscroll();
            } else {
                startAutoscroll();
            }
        }

        function startAutoscroll() {
            isScrolling = true;
            btnAutoscroll.textContent = "‚è∏";
            btnAutoscroll.classList.add('active');
            scrollInterval = setInterval(() => {
                window.scrollBy(0, scrollSpeed);
            }, 15); 
        }

        function stopAutoscroll() {
            isScrolling = false;
            btnAutoscroll.textContent = "‚ñ∂Ô∏è";
            btnAutoscroll.classList.remove('active');
            clearInterval(scrollInterval);
        }

        btnAutoscroll.addEventListener('click', toggleAutoscroll);

        // Control de velocidad con teclado (Flechas Arriba/Abajo)
        document.addEventListener('keydown', (e) => {
            if (!document.getElementById('viewer-section').classList.contains('hidden')) {
                if (e.key === "ArrowUp") {
                    scrollSpeed = Math.max(1, scrollSpeed - 1); // M√≠nimo 1
                    console.log("Velocidad:", scrollSpeed);
                } else if (e.key === "ArrowDown") {
                    scrollSpeed = Math.min(10, scrollSpeed + 1); // M√°ximo 10 (ejemplo)
                    console.log("Velocidad:", scrollSpeed);
                } else if (e.key === " " || e.code === "Space") { // Barra espaciadora pausa
                     e.preventDefault();
                     toggleAutoscroll();
                }
            }
        });

        // Descargas (Abrir la sub-p√°gina/modal)
        function toggleDownloadModal(show) {
             if (show) {
                 modalDownload.classList.remove('hidden');
                 stopAutoscroll(); // Pausar si se abre el modal
                 const linksContainer = document.getElementById('download-links-container');
                 linksContainer.innerHTML = '';
                 if (currentDownloadData) {
                     const link = document.createElement('a');
                     link.href = currentDownloadData.data;
                     link.download = currentDownloadData.name;
                     link.className = 'download-link-item';
                     link.innerHTML = `üì• Descargar archivo: ${currentDownloadData.name}`;
                     linksContainer.appendChild(link);
                 } else {
                      linksContainer.innerHTML = '<p>No se subi√≥ ning√∫n archivo de descarga para este cap√≠tulo.</p>';
                 }

             } else {
                 modalDownload.classList.add('hidden');
             }
        }

        btnDownload.addEventListener('click', () => toggleDownloadModal(true));

        // Inicializar la app
        loadData();
    </script>
</body>
</html>
